function LoadCity() { var a = $.cookie("SelectedCityCountry"), b = $.cookie("SelectedWoeid"); if (a && b) try { for (var c = a.replace(/;;/g, ";").split(";"), d = b.replace(/;;/g, ";").split(";"), e = 0; e < c.length && e < d.length; e++) { var f = e == c.length - 1; c[e] && d[e] && AddNewCityLocation(d[e], c[e], !1, f) } } catch (a) { LogError(a) } else $.getJSON("http://api.hostip.info/get_json.php").done(function (a) { a && a.ip ? $.ajax({ method: "get", url: "http://api.ipinfodb.com/v3/ip-city/?key=debfc7c448e8b9d818084949fa23db2382f2488fbfd52e805a3e059091c65d8b&ip=" + a.ip + "&format=json", contentType: "application/json; charset=utf-8", dataType: "jsonp", success: function (a) { a && a.countryName && a.cityName ? AddDefaultCityLocation(a.countryName, a.cityName) : AddDefaultCityLocation() }, error: function (a) { AddDefaultCityLocation() } }) : AddDefaultCityLocation() }).fail(function () { AddDefaultCityLocation() }) } function AssignCityControls() { $("#Location").autocomplete({ source: function (a, b) { var c = a.term; c && c.length > 0 && $.getJSON($("#CurrentLang").val() + "/api/APIProfile/cities?cityName=" + c).done(function (a) { var c = []; if (a) for (var d = 0; d < a.length; d++) { var e = a[d]; c.push(e) } b(c) }) }, select: function (a, b) { var c = b.item; return AddNewCityLocation(c.woeid, c.town + ", " + c.country, !0, !0), $.ajax({ method: "get", url: $("#CurrentLang").val() + "/api/APIProfile/requestcity?woeid=" + c.woeid, contentType: "application/json; charset=utf-8", success: function (a) { var b = c.country; b.length > 11 && (b = b.substring(0, 8) + "...") }, error: function (a) { ShowError(error) } }), !1 } }).autocomplete("instance")._renderItem = function (a, b) { return $("<li>").append("<a>" + b.country + "&nbsp" + b.town + (b.admin ? ", " + b.admin : "") + (b.admin1 ? " ," + b.admin1 : "") + (b.admin2 ? " ," + b.admin2 : "") + "</a>").appendTo(a) } } function AddDefaultCityLocation(a, b) { a && b ? $.ajax({ method: "get", url: $("#CurrentLang").val() + "/api/APIProfile/city?cityName=" + b + ", " + a, contentType: "application/json; charset=utf-8", success: function (c) { a.length > 11 && (a = a.substring(0, 8) + "..."), AddNewCityLocation(c, b + ", " + a, !0, !0) }, error: function (a) { "ru" == $("#CurrentLang").val() ? AddNewCityLocation("484907", "Taganrog, RU", !1, !0) : AddNewCityLocation("5391959", "San Francisco, US", !1, !0) } }) : "ru" == $("#CurrentLang").val() ? AddNewCityLocation("484907", "Taganrog, RU", !1, !0) : AddNewCityLocation("5391959", "San Francisco, US", !1, !0) } function AddNewCityLocation(a, b, c, d) { try { var e = $(".selectedContent").length, f = 0; if ($(".selectedContent").each(function () { if ("SelectedLocation" !== $(this).parent().attr("id")) { var a = $(this).text(); if (a == location) return void (f = 1) } }), f || "" == location || null == location) return void ShowError(pleaseTypeUniqueLocation); if (e >= 6) return void ShowError(noMoreCities); var g = document.getElementById("SelectedLocation"), h = g.cloneNode(!0); h.id = h.id + guid(), h.style.display = "block", h.setAttribute("woeid", a), $(".instaBlock").before(h); var i = $("#" + h.id + " > .selectedContent"); i.text(b), $("#Location").val(""); var j = $.cookie("SelectedCityCountry"), k = $.cookie("SelectedWoeid"); j && k ? (j = j.replace(/;;/g, ";"), k = k.replace(/;;/g, ";"), 1 == c && b && a && j.indexOf(b) < 0 && k.indexOf(a) < 0 && ($.cookie("SelectedCityCountry", j + ";" + b, { path: "/" }), $.cookie("SelectedWoeid", k + ";" + a, { path: "/" }))) : 1 == c && b && a && ($.cookie("SelectedCityCountry", b, { path: "/" }), $.cookie("SelectedWoeid", a, { path: "/" })), 1 == d && SetActiveLocation(h) } catch (a) { LogError(a), isWorking = !1 } } function SetActiveLocation(a) { if (1 == isWorking) return void ShowError(pleaseWait); try { isWorking = !0, $(".selectedLocation").each(function () { $(this).removeClass("activeLocation") }), a.className += " activeLocation"; var c = (a.children[0].innerHTML, a.children[0].getAttribute("woeid")), d = a.getAttribute("woeid"); c && "undefined" != c ? GetSuggestionsForToday(c) : d && "undefined" != d ? GetSuggestionsForToday(d) : ShowError("No woeid!") } catch (a) { LogError(a), isWorking = !1 } } function GetSuggestionsForToday(a) { GetAllData(a, null, 0) } function GetSuggestionsForecast(a) { if (1 == isWorking) return void ShowError(pleaseWait); a.className += "suggestion-header-active"; var b = a.getAttribute("date"), c = a.getAttribute("woeid"); GetAllData(c, b, 0) } function GetInstagramPhotosByLocation(a) { } function GetAllData(a, b, c) { $(".weather-panel").css("visibility", "hidden"), $(".weather-panel").css("opacity", "0.0"), $.getJSON($("#CurrentLang").val() + "/api/APISuggestions/weather?woeid=" + a + "&date=" + b).done(function (d) { var e = $(".mainTab > li.active > a").attr("href"); "#spring" == e ? ($("#spring").show(), $(".suggestions-panel-conent > .tab-content > spring").addClass("active")) : "#summer" == e ? ($("#summer").show(), $(".suggestions-panel-conent > .tab-content > summer").addClass("active")) : "#autumn" == e ? ($("#autumn").show(), $(".suggestions-panel-conent > .tab-content > autumn").addClass("active")) : "#winter" == e && ($("#winter").show(), $(".suggestions-panel-conent > .tab-content > winter").addClass("active")), $(".weatherConditionIcon").attr("src", "/img/wicons/" + d.conditionIcon), $(".weatherDescription").text(d.shortDescription + (d.windDirection ? ", " + d.windDirection : "")); var f = ""; f = "?" == d.effectiveTemperature ? d.temperature : d.effectiveTemperature, $(".eftemperature").text(f), $(".system").text(d.temperatureUnits), $(".tempmax").text(d.temperatureMax + d.temperatureUnits), $(".tempmin").text(d.temperatureMin + d.temperatureUnits), $(".humidity > .subValue").text(d.athmosphereHumidity + d.humidityUnits), $(".pressure > .subValue").text(d.athmospherePressure), $(".pressure > .subDesc").text(d.pressureUnits), $(".windspeed > .subValue").text(d.windSpeed), $(".windspeed > .subDesc").text(d.speedUnits), $(".sunrise > .subValue").text(d.sunrise), $(".sunset > .subValue").text(d.sunset), 1 == d.iswindy && $(".windspeed").css("border-color", "red"), "?" == d.athmosphereHumidity && $(".humidity").hide(), "?" == d.athmospherePressure && $(".pressure").hide(), "?" == d.windSpeed && $(".windspeed").hide(), "?" == d.sunrise && $(".sunrise").hide(), "?" == d.sunset && $(".sunset").hide(), $(".weather-panel").css("visibility", "visible").animate({ opacity: 1 }, 1e3); try { if (d.forecasts) { $("#SuggestionForecasts").empty(); var g = 0; for (var h in d.forecasts) g++; var i = !0; for (var h in d.forecasts) { i = !1; var j = document.getElementById("SuggestionTodayTemplate"), k = j.cloneNode(!0); k.id = "", k.style.display = "block"; var l = d.forecasts[h]; if (k.childNodes[0].setAttribute("date", l), k.childNodes[0].setAttribute("woeid", a), k.childNodes[0].setAttribute("onclick", "GetSuggestionsForecast(this);"), k.childNodes[0].innerHTML = h.toUpperCase(), b ? b == l && (k.className += " suggestion-header-active") : d.forecastDate.indexOf(l) > -1 && (k.className += " suggestion-header-active"), $("#SuggestionForecasts").append(k), g > 1) { var m = document.createElement("div"); m.className = "suggestion-header-splitter", m.innerHTML = "&nbsp;", $("#SuggestionForecasts").append(m) } --g } if (i) { var j = document.getElementById("SuggestionTodayTemplate"), k = j.cloneNode(!0); k.id = "", k.style.display = "block", $("#SuggestionForecasts").append(k), k.childNodes[0].innerHTML = "&nbsp;" } } } catch (a) { ShowError(jsForecastError), LogError(a) } sessionStorage.getItem("accessToken") && $.ajaxSetup({ headers: { Authorization: "Bearer " + sessionStorage.getItem("accessToken") } }); var n = $(".activeLocation > .selectedContent").text(), o = "Сегодня в " + n + " температура " + f + " " + d.temperatureUnits + ". "; "en" == $("#CurrentLang").val() && (o = "Today in " + n + " temperature is " + f + " " + d.temperatureUnits + ". "), SearchClothes(a, b, c, o) }).fail(function (a) { LogError(a), isWorking = !1 }) } function SearchClothes(a, b, c, d) { ShowProgressBar(), $.getJSON($("#CurrentLang").val() + "/api/APISuggestions/suggestion?woeid=" + a + "&fresh=" + c + "&date=" + b).done(function (c) { try { if (c) { if (sessionStorage.setItem("suggestedItems", JSON.stringify(c)), c.forecastDescription) { var e = $("#SpecialNotes"); e.html(c.forecastDescription) } ShowSuggestedItems(c, a, b), $(".pluso").attr("data-description", d + c.forecastDescription), $(".pluso").attr("data-title", d + c.forecastDescription), $("meta[name=description]").attr("content", d + c.forecastDescription), $('meta[property="og:description"]').attr("content", d + c.forecastDescription), $('meta[property="og:title"]').attr("content", d + c.forecastDescription) } if ($(".suggestion-item").hover(function () { $(this).find(".suggestion-item-info").show() }, function () { $(this).find(".suggestion-item-info").hide() }), HideProgressBar(), $(".clothes-panel").css("visibility", "visible").animate({ opacity: 1 }, 1e3), c.commonSuggestedItems) { var f = $("#commonSuggestionTypes option:selected").attr("data"); ReloadCommonItemsByFilter(c, f) } } catch (a) { LogError(a) } isWorking = !1 }).fail(function (a) { LogError(a), isWorking = !1 }) } function ReloadCommonItemsByFilter(a, b) { if (a.commonSuggestedItems && b) { var c = a.commonSuggestedItems[b]; $("#FullSuggestionNotes > li").remove(); var d = $("#FullSuggestionNotes"); $.each(c, function (a) { var b = c[a]; $("<li/>").addClass("phi-common-item").text(b.name).appendTo(d) }) } } function CloseSelected(a) { if (1 == isWorking) return void ShowError(pleaseWait); isWorking = !0; var b = $(".selectedContent").length; if (b <= 2) ShowError(dontDeleteCity), isWorking = !1; else try { var c = a.getAttribute("id"), d = 0, e = 0; $("#SelectedLocationContainer > .selectedLocation").each(function () { e += 1, $(this).attr("id") == c && (d = e) }); var f = $.cookie("SelectedCityCountry"), g = $.cookie("SelectedWoeid"); if (f && g) { f = f.replace(/;;/g, ";"), g = g.replace(/;;/g, ";"); var h = f.split(";"), i = g.split(";"); f = "", g = ""; for (var j = 0; j < h.length && j < i.length; j++) d != j + 1 && h[j] && i[j] && (f += h[j] + ";", g += i[j] + ";"); f = f.substring(0, f.length - 1), g = g.substring(0, f.length - 1), $.cookie("SelectedCityCountry", f, { path: "/" }), $.cookie("SelectedWoeid", g, { path: "/" }) } var k = a.getAttribute("class").indexOf("activeLocation") >= 0, l = document.getElementById("SelectedLocationContainer"); if (l.removeChild(a), k) { $(".selectedLocation").each(function () { $(this).removeClass("activeLocation") }); var m = $(".selectedLocation").last(); m ? (m.addClass("activeLocation"), GetSuggestionsForToday(m.attr("woeid"))) : (alert(jsError), isWorking = !1) } else isWorking = !1 } catch (a) { LogError(a) } return window.event.cancelBubble = !0, window.event.stopPropagation(), !1 } function ShowSuggestedItems(a, b, c) { var d = $("#actiontypes option:selected").attr("data"); if (a.suggestedItems) { $(".listview-wrapper > div").remove(); var e = $(".listview-wrapper"), f = a.suggestedItems[d], g = 0; for (var h in f) { var i = f[h], j = document.getElementById("SuggestionItemTemplate"), k = j.cloneNode(!0); k.id = k.id + g, k.style.display = "block"; var l = document.createElement("div"); l.className = "item", l.appendChild(k), e.append(l), k.className += " suggestion-item-active"; var m = $("#" + k.id + " > .suggestion-item-title"); m.text(i.name), k.title = i.description; var n = $("#" + k.id + " > .suggestion-item-content > a > img"); n.attr("src", i.imageUrl); var o = $("#" + k.id + " > .suggestion-item-content > a"); o.attr("href", i.referrerUrl); var p = $("#" + k.id + " > .suggestion-item-info > div > .suggestion-item-price"); p.text(i.price); var q = $("#" + k.id + " > .suggestion-item-info > div > .suggestion-item-vendor"); q.text(i.provideBy), ++g } b && $(".moreButton").click(function () { SearchClothes(b, c, 1) }) } } function ShowProgressBar() { $(".clothes-progress-bar").show(); var a = { lines: 13, length: 28, width: 14, radius: 42, scale: 1, corners: 1, color: "#000", opacity: .25, rotate: 0, direction: 1, speed: 1, trail: 60, fps: 20, zIndex: 2e9, className: "spinner", top: "35%", left: "50%", shadow: !1, hwaccel: !1, position: "absolute" }, b = document.getElementById("progress-bar"); new Spinner(a).spin(b) } function HideProgressBar() { $(".clothes-progress-bar").hide(), $("#progress-bar > *").remove() } $(document).ready(function () { isWorking = !1, $(".selectpicker").selectpicker(), "en" == $("#CurrentLang").val() && ($(".sunset").addClass("time-en"), $(".sunrise").addClass("time-en")), LoadCity(), AssignCityControls(), $("#actiontypes").change(function () { var a = sessionStorage.getItem("suggestedItems"); if (a) { var b = jQuery.parseJSON(a); b && ShowSuggestedItems(b, null, null) } }), $("#commonSuggestionTypes").change(function () { var a = sessionStorage.getItem("suggestedItems"); if (a) { var b = jQuery.parseJSON(a), c = $("#commonSuggestionTypes option:selected").attr("data"); b && c && ReloadCommonItemsByFilter(b, c) } }), $(".mainTab").bind("click", function (a) { "#spring" == a.target.hash ? ($("#summer").hide(), $("#autumn").hide(), $("#winter").hide(), $("#spring").show(), $(".suggestions-panel-conent > .tab-content > spring").addClass("active")) : "#summer" == a.target.hash ? ($("#spring").hide(), $("#autumn").hide(), $("#winter").hide(), $("#summer").show(), $(".suggestions-panel-conent > .tab-content > summer").addClass("active")) : "#autumn" == a.target.hash ? ($("#spring").hide(), $("#summer").hide(), $("#winter").hide(), $("#autumn").show(), $(".suggestions-panel-conent > .tab-content > autumn").addClass("active")) : "#winter" == a.target.hash && ($("#spring").hide(), $("#autumn").hide(), $("#summer").hide(), $("#winter").show(), $(".suggestions-panel-conent > .tab-content > winter").addClass("active")) }) }); var isWorking = !1;